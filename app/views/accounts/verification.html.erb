<%#
# This file is part of the OpenWISP User Management System
#
# Copyright (C) 2012 OpenWISP.org
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#%>

<% content_for :after_defaults do %>
    <%= javascript_tag "$(function(){
        owums.periodicallyCheckVerification({
            frequency: 2,
            url: '#{ url_for(:action => 'verification', :id => @single_access_token) }',
            update: '#verification'
        });
    }); " %>
<% end %>

<div class="grid_12">
  <div id="verification">
    <%= render :partial => 'verification' %>
  </div>
</div>
<div class="clear"></div>

<% if(@account.verify_with_gestpay?) %>
<div class="overlay">
  <a class="close">x</a>
  <iframe id="bank-gateway" src="<%= @account.verify_with_credit_card() %>"></iframe>
</div>

<div id="mask"></div>
<div id="loading-overlay"></div>

<script type="text/javascript">
  (function(){
    $.fn.resizeElement = function(padding){
      padding = padding || 60;
      var el = $(this);  
      el.height($(window).height()-padding)
      .width($(window).width()-padding);
      return el;
    }
    $.fn.centerElement = function(){
      var el = $(this);
      el.css('top', ($(window).height() - el.height()) / 2)
      .css('left', ($(window).width() - el.width()) / 2);
      return el;
    }
    $.fn.togglePop = function(speed){
      speed = speed || 150;
      el = $(this);
      el.centerElement();
      (el.is(':visible')) ? el.fadeOut(speed) : el.fadeIn(speed);
      return el;
    }
    
    var overlay = $('.overlay');
    
    window.toggleOverlay = function(){
      var mask = $('#mask'),
          close = $('.close');
      mask.css('opacity','0').show().fadeTo(250, 0.7);
      overlay.resizeElement().centerElement().fadeIn(250);
      if($.data(close.get(0), 'events') === undefined){
        close.click(function(e){
        $(this).parent().fadeOut();
            mask.fadeOut();
        });
      }
    }
    
    $('#loading-overlay').togglePop();    
    
    $(window).resize(function(e){
      overlay.resizeElement().centerElement();
    }).load(function(e){
      toggleOverlay();
    });
    $('iframe').one('load', function(){
      $('#loading-overlay').togglePop();
    });
  })();
</script>
<% end %>